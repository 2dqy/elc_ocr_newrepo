# åŒ»ç–—å›¾åƒåˆ†æAPI

è¿™æ˜¯ä¸€ä¸ªç”¨äºè¯†åˆ«åŒ»ç–—å›¾åƒä¸­è¡€å‹ã€è¡€ç³–ç­‰ä¿¡æ¯çš„FastAPIåº”ç”¨ç¨‹åºã€‚

## é¡¹ç›®ç»“æ„

```
project_root/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/             # APIè·¯ç”±
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â””â”€â”€ app.py
â”‚   â”œâ”€â”€ core/           # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”œâ”€â”€ db/             # æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ database.py
â”‚   â”œâ”€â”€ models/         # æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ services/       # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ static/         # é™æ€æ–‡ä»¶
â”‚   â””â”€â”€ main.py         # åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ tests/              # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ requirements.txt    # ä¾èµ–
â””â”€â”€ .env               # ç¯å¢ƒå˜é‡
```

## å®‰è£…

1. å…‹éš†é¡¹ç›®ï¼š
```bash
git clone <repository_url>
cd <project_directory>
```

2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼š
```bash
uv init
uv venv
```

3. å®‰è£…ä¾èµ–ï¼š
```bash
uv add -r requirements.txt
```

4. é…ç½®ç¯å¢ƒå˜é‡ï¼š
å¤åˆ¶ `.env.example` åˆ° `.env` å¹¶å¡«å†™å¿…è¦çš„é…ç½®ï¼š
```bash
cp .env.example .env
```

## è¿è¡Œ

å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
```bash
source .venv/bin/activate
uvicorn app.main:app --reload 
```

æœåŠ¡å™¨å°†åœ¨ http://localhost:8000 è¿è¡Œ

## APIæ–‡æ¡£

è®¿é—® http://localhost:8000/docs æŸ¥çœ‹APIæ–‡æ¡£

## ä¸»è¦åŠŸèƒ½

1. Tokenç®¡ç†
   - åˆ›å»ºæ–°Token
   - éªŒè¯Token
   - æ›´æ–°Tokenä½¿ç”¨æ¬¡æ•°

2. å›¾åƒåˆ†æ
   - ä¸Šä¼ åŒ»ç–—å›¾åƒ
   - è¯†åˆ«è¡€å‹æ•°æ®
   - è¯†åˆ«è¡€ç³–æ•°æ®

## å¼€å‘æŒ‡å—

1. æ·»åŠ æ–°çš„APIç«¯ç‚¹ï¼š
   - åœ¨ `app/api/v1/app.py` åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
   - åœ¨ `app/services/` å®ç°ä¸šåŠ¡é€»è¾‘
   - åœ¨ `app/main.py` æ³¨å†Œæ–°çš„è·¯ç”±

2. æ•°æ®åº“æ“ä½œï¼š
   - æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½åº”è¯¥é€šè¿‡ `app/db/database.py` ä¸­çš„Databaseç±»è¿›è¡Œ
   - åœ¨ `app/models/` å®šä¹‰æ–°çš„æ•°æ®åº“æ¨¡å‹

## è´¡çŒ®

æ¬¢è¿æäº¤Pull Requestå’ŒIssueã€‚

## è®¸å¯è¯

[MIT License](LICENSE)

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### å›¾åƒè¯†åˆ«æ¥å£ `/upload/image`

#### æ¥å£æ¦‚è¿°
- **è·¯å¾„**: `POST /upload/image`
- **åŠŸèƒ½**: ä¸Šä¼ åŒ»ç–—è®¾å¤‡å›¾åƒï¼Œè‡ªåŠ¨è¯†åˆ«è¡€å‹è®¡æˆ–è¡€ç³–ä»ªæ•°æ®
- **æ”¯æŒè®¾å¤‡**: è¡€å‹è®¡ã€è¡€ç³–ä»ª

#### è¾“å…¥å‚æ•°
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file | UploadFile | æ˜¯ | åŒ»ç–—è®¾å¤‡å›¾åƒæ–‡ä»¶ |
| token | string | æ˜¯ | éªŒè¯ä»¤ç‰Œ |

#### æ–‡ä»¶é™åˆ¶
- **æ–‡ä»¶ç±»å‹**: ä»…æ”¯æŒå›¾åƒæ–‡ä»¶ (image/*)
- **æ–‡ä»¶å¤§å°**: æœ€å¤§500KB
- **åƒç´ èŒƒå›´**: 28Ã—28Ã—4 ~ 28Ã—28Ã—8192åƒç´ 

#### å¤„ç†æµç¨‹

##### 1. å‰ç½®éªŒè¯
- Tokenæœ‰æ•ˆæ€§éªŒè¯
- æ–‡ä»¶ç±»å‹æ£€æŸ¥ï¼ˆå¿…é¡»ä¸ºå›¾åƒï¼‰
- æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆâ‰¤500KBï¼‰
- ç”Ÿæˆ16ä½éšæœºæ–‡ä»¶ä¸Šä¼ ID
- è·å–å®¢æˆ·ç«¯IPåœ°å€

##### 2. å›¾åƒé¢„å¤„ç†
- å›¾åƒå°ºå¯¸ä¼˜åŒ–å’Œå‹ç¼©
- Base64ç¼–ç è½¬æ¢
- åƒç´ èŒƒå›´æ ‡å‡†åŒ–

##### 3. AIè¯†åˆ«åˆ†æ
**ä½¿ç”¨æ¨¡å‹**: DashScope qwen-vl-ocr-latest

**è¯†åˆ«å†…å®¹**:
- è®¾å¤‡å“ç‰Œå’Œå‹å·
- è®¾å¤‡ç±»å‹åˆ¤æ–­ï¼ˆè¡€å‹è®¡/è¡€ç³–ä»ªï¼‰
- æµ‹é‡æ•°å€¼æå–
- æµ‹é‡æ—¶é—´æå–ï¼ˆä»å›¾åƒä¸­ï¼‰
- å¯é æ€§è¯„ä¼°

##### 4. æ•°æ®éªŒè¯ä¸å¤„ç†
**è¡€å‹æ•°æ®éªŒè¯**:
- æ£€æŸ¥æ”¶ç¼©å‹(sys)ã€èˆ’å¼ å‹(dia)ã€å¿ƒç‡(pul)ä¸‰ä¸ªå‚æ•°
- å¦‚æœä»»ä½•å‚æ•°ä¸ºnullï¼Œè¿”å›"å›¾åƒæœ‰é”™è¯¯æˆ–ä¸æ¸…æ™°"é”™è¯¯

**æ•°æ®æ¸…æ´—**:
- æ ¹æ®è®¾å¤‡ç±»å‹åˆ é™¤æ— å…³å­—æ®µ
- ç»Ÿä¸€æ•°æ®æ ¼å¼

##### 5. å•ä½æ ‡å‡†åŒ–

**è¡€å‹å•ä½å¤„ç†**:
- æ”¶ç¼©å‹/èˆ’å¼ å‹: è‡ªåŠ¨æ·»åŠ  `mmHg`
- å¿ƒç‡: è‡ªåŠ¨æ·»åŠ  `bpm`

**è¡€ç³–å•ä½å¤„ç†**:
- ç›®æ ‡å•ä½: `mmol/L`
- è‡ªåŠ¨å•ä½è½¬æ¢: å½“è¡€ç³–å€¼ > 20æ—¶ï¼Œè®¤ä¸ºæ˜¯mg/dLå•ä½ï¼Œè‡ªåŠ¨é™¤ä»¥18è½¬æ¢
- ç¤ºä¾‹: `108mg/dL` â†’ `6.0mmol/L`

##### 6. åç«¯æ•°æ®è¡¥å……
ç³»ç»Ÿè‡ªåŠ¨æ·»åŠ ä»¥ä¸‹åç«¯å‚æ•°:
- `measure_date`: å½“å‰æ—¥æœŸ (YYYY-MM-DD)
- `source_ip`: å®¢æˆ·ç«¯IPåœ°å€
- `ai_usage`: AIä½¿ç”¨é‡ (total_tokens Ã— 10)
- `file_upload_id`: 16ä½éšæœºæ–‡ä»¶ID
- `file_name`: åŸå§‹æ–‡ä»¶å
- `file_size`: æ–‡ä»¶å¤§å°(å­—èŠ‚)
- `token`: ç”¨æˆ·æä¾›çš„è®¤è¯ä»¤ç‰Œ

#### æˆåŠŸå“åº”æ ¼å¼

**è¡€å‹æ•°æ®ç¤ºä¾‹**:
```json
{
  "meta": "success",
  "data": {
    "brand": "Omron",
    "measure_date": "2024-01-15",
    "measure_time": "14:30:00",
    "category": "blood_pressure",
    "blood_pressure": {
      "sys": "120mmHg",
      "dia": "80mmHg", 
      "pul": "72bpm"
    },
    "suggest": "è¡€å‹æ­£å¸¸ï¼Œè¯·ä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼",
    "analyze_reliability": 0.95,
    "status": "completed",
    "source_ip": "192.168.1.100",
    "ai_usage": 6270,
    "file_upload_id": "A1B2C3D4E5F6G7H8",
    "file_name": "blood_pressure.jpg",
    "file_size": 245760,
    "token": "abc123def456"
  }
}
```

**è¡€ç³–æ•°æ®ç¤ºä¾‹**:
```json
{
  "meta": "success", 
  "data": {
    "brand": "Roche",
    "measure_date": "2024-01-15",
    "measure_time": "09:15:00",
    "category": "blood_sugar",
    "blood_sugar": {
      "value": "5.8mmol/L"
    },
    "suggest": "è¡€ç³–æ°´å¹³æ­£å¸¸ï¼Œå»ºè®®ç»§ç»­ä¿æŒè‰¯å¥½çš„é¥®é£Ÿä¹ æƒ¯",
    "analyze_reliability": 0.92,
    "status": "completed",
    "source_ip": "192.168.1.100", 
    "ai_usage": 5840,
    "file_upload_id": "X9Y8Z7W6V5U4T3S2",
    "file_name": "blood_sugar.jpg",
    "file_size": 198432,
    "token": "xyz789uvw012"
  }
}
```

#### é”™è¯¯å“åº”æ ¼å¼

**æ–‡ä»¶æ ¼å¼é”™è¯¯**:
```json
{
  "errors": [
    {
      "messages": "å”¯æœ‰ä¸Šè½½å›¾åƒæ–‡ä»¶",
      "extensions": {
        "code": "UPLOAD_FILE_FAIL"
      }
    }
  ]
}
```

**æ–‡ä»¶å¤§å°è¶…é™**:
```json
{
  "errors": [
    {
      "messages": "æ–‡ä»¶å¤§å°è¶…è¿‡500KBåˆ¶",
      "extensions": {
        "code": "UPLOAD_FILE_FAIL" 
      }
    }
  ]
}
```

**å›¾åƒä¸æ¸…æ™°æˆ–æœ‰é”™è¯¯**:
```json
{
  "errors": [
    {
      "message": "å›¾åƒæœ‰é”™è¯¯æˆ–ä¸æ¸…æ™°",
      "extensions": {
        "code": "IMG__ERROR"
      }
    }
  ]
}
```

**OCRè¯†åˆ«å¤±è´¥**:
```json
{
  "errors": [
    {
      "message": "OCRè§£æå¤±è´¥",
      "extensions": {
        "code": "OCR__ERROR"
      }
    }
  ]
}
```

#### ç‰¹æ®Šå¤„ç†é€»è¾‘

1. **è¡€å‹å®Œæ•´æ€§éªŒè¯**: è¡€å‹æ•°æ®å¿…é¡»åŒ…å«æ”¶ç¼©å‹ã€èˆ’å¼ å‹ã€å¿ƒç‡ä¸‰ä¸ªå®Œæ•´å‚æ•°
2. **æ™ºèƒ½å•ä½è½¬æ¢**: è‡ªåŠ¨è¯†åˆ«è¡€ç³–å•ä½å¹¶è½¬æ¢ä¸ºç»Ÿä¸€çš„mmol/Læ ¼å¼
3. **æ•°æ®æ¸…æ´—**: æ ¹æ®è®¾å¤‡ç±»å‹è‡ªåŠ¨åˆ é™¤æ— å…³æ•°æ®å­—æ®µ
4. **Tokenä½¿ç”¨è®¡æ•°**: æˆåŠŸè¯†åˆ«åè‡ªåŠ¨æ›´æ–°Tokenä½¿ç”¨æ¬¡æ•°
5. **æ‰§è¡Œæ—¶é—´ç›‘æ§**: è®°å½•å®Œæ•´å¤„ç†æ—¶é—´ç”¨äºæ€§èƒ½ç›‘æ§

#### æŠ€æœ¯æ ˆ
- **OCRå¼•æ“**: é˜¿é‡Œäº‘DashScope qwen-vl-ocr-latest
- **å›¾åƒå¤„ç†**: PIL/Pillow
- **APIæ¡†æ¶**: FastAPI
- **æ•°æ®éªŒè¯**: å¤šå±‚éªŒè¯æœºåˆ¶

#### ğŸ“‹ æ—¥å¿—è®°å½•çš„å­—æ®µåŒ…æ‹¬ï¼š
â— client_ip: å®¢æˆ·ç«¯IPåœ°å€
â— token: ä½¿ç”¨çš„token
â— api_endpoint: APIç«¯ç‚¹
â— status: è¯·æ±‚çŠ¶æ€ ('success', 'failed', 'not_relevant', 'error')
â— file_upload_id: æ–‡ä»¶ä¸Šä¼ IDï¼ˆä»…å›¾åƒæ¥å£ï¼‰
â— file_name: æ–‡ä»¶åï¼ˆä»…å›¾åƒæ¥å£ï¼‰
â— file_size: æ–‡ä»¶å¤§å°ï¼ˆä»…å›¾åƒæ¥å£ï¼‰
â— ai_usage: AIä½¿ç”¨é‡ï¼ˆä»…å›¾åƒæ¥å£ï¼‰
â— error_message: é”™è¯¯æ¶ˆæ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
â— error_code: é”™è¯¯ä»£ç ï¼ˆå¤±è´¥æ—¶ï¼‰

# OCR æ¨¡å‹åˆ‡æ¢åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®ç°åœ¨æ”¯æŒä¸¤ç§OCRæ¨¡å‹ï¼š
- **åƒé—®æ¨¡å‹ (Qwen)**: é˜¿é‡Œäº‘ç™¾ç‚¼çš„ qwen-vl-ocr-0413 æ¨¡å‹
- **OpenAIæ¨¡å‹**: Azure OpenAI çš„ gpt-4o æ¨¡å‹

## é…ç½®æ–¹æ³•

### 1. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# æ¨¡å‹é€‰æ‹© (qwen æˆ– openai)
MODEL_TYPE=qwen

# åƒé—®æ¨¡å‹é…ç½®
DASHSCOPE_API_KEY=sk-your-dashscope-key

# OpenAIæ¨¡å‹é…ç½®
AZURE_OPENAI_ENDPOINT=https://your-endpoint.openai.azure.com/
AZURE_OPENAI_API_KEY=your-azure-openai-key
AZURE_OPENAI_API_VERSION=2024-12-01-preview
AZURE_OPENAI_DEPLOYMENT=gpt-4o
AZURE_OPENAI_MODEL=gpt-4o
```

### 2. æ¨¡å‹åˆ‡æ¢

#### æ–¹æ³•ä¸€ï¼šé€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢ï¼ˆæ¨èï¼‰
```bash
# ä½¿ç”¨åƒé—®æ¨¡å‹
MODEL_TYPE=qwen

# ä½¿ç”¨OpenAIæ¨¡å‹
MODEL_TYPE=openai
```

#### æ–¹æ³•äºŒï¼šä»£ç ä¸­åŠ¨æ€åˆ‡æ¢
```python
from app.services.model_fun import get_ocr_model

# ä½¿ç”¨åƒé—®æ¨¡å‹
qwen_model = get_ocr_model("qwen")

# ä½¿ç”¨OpenAIæ¨¡å‹
openai_model = get_ocr_model("openai")

# ä½¿ç”¨é»˜è®¤æ¨¡å‹ï¼ˆæ ¹æ®ç¯å¢ƒå˜é‡MODEL_TYPEï¼‰
default_model = get_ocr_model()
```

## æ¨¡å‹å·®å¼‚

### åƒé—®æ¨¡å‹ (Qwen)
- **ä¼˜åŠ¿**: ä¸“é—¨é’ˆå¯¹OCRä¼˜åŒ–ï¼Œè¯†åˆ«å‡†ç¡®åº¦é«˜
- **å›¾åƒå¤„ç†**: ä½¿ç”¨åŸå§‹å›¾åƒï¼Œå†…éƒ¨è¿›è¡Œä¼˜åŒ–å¤„ç†
- **è¿”å›æ ¼å¼**: éœ€è¦ç¡®ä¿åŒ…å« `data` å­—æ®µ
- **æˆæœ¬**: ç›¸å¯¹è¾ƒä½

### OpenAIæ¨¡å‹ (GPT-4o)
- **ä¼˜åŠ¿**: å¼ºå¤§çš„ç†è§£èƒ½åŠ›ï¼Œæ”¯æŒå¤æ‚åœºæ™¯
- **å›¾åƒå¤„ç†**: éœ€è¦å‹ç¼©å›¾åƒåˆ°1024x1024ä»¥ä¸‹
- **è¿”å›æ ¼å¼**: ç›´æ¥è¿”å›åŒ…å« `data` å­—æ®µçš„JSON
- **æˆæœ¬**: ç›¸å¯¹è¾ƒé«˜

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```python
import asyncio
from app.services.model_fun import get_ocr_model

async def analyze_image():
    # è·å–æ¨¡å‹å®ä¾‹
    model = get_ocr_model()  # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æ¨¡å‹
    
    # è¯»å–å›¾åƒæ–‡ä»¶
    with open("blood_pressure.jpg", "rb") as f:
        image_content = f.read()
    
    # åˆ†æå›¾åƒ
    result = model.analyze_image(image_content, "blood_pressure.jpg")
    
    print(result)

# è¿è¡Œç¤ºä¾‹
asyncio.run(analyze_image())
```

### åœ¨FastAPIä¸­ä½¿ç”¨
```python
from app.services.model_fun import get_ocr_model

@router.post("/upload")
async def upload_file(file: UploadFile = File(...)):
    # è·å–æ¨¡å‹å®ä¾‹
    ocr_model = get_ocr_model()
    
    # è¯»å–æ–‡ä»¶å†…å®¹
    file_content = await file.read()
    
    # åˆ†æå›¾åƒ
    result = ocr_model.analyze_image(file_content, file.filename)
    
    return result
```

## æµ‹è¯•æ¨¡å‹åˆ‡æ¢

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
python test_model_switch.py
```

è¿™å°†æµ‹è¯•ä¸¤ç§æ¨¡å‹çš„åˆ›å»ºå’Œé…ç½®æ˜¯å¦æ­£ç¡®ã€‚

## æ³¨æ„äº‹é¡¹

1. **APIå¯†é’¥**: ç¡®ä¿ç›¸åº”æ¨¡å‹çš„APIå¯†é’¥å·²æ­£ç¡®é…ç½®
2. **ç½‘ç»œè¿æ¥**: ç¡®ä¿èƒ½å¤Ÿè®¿é—®ç›¸åº”çš„APIç«¯ç‚¹
3. **å›¾åƒæ ¼å¼**: æ”¯æŒå¸¸è§çš„å›¾åƒæ ¼å¼ï¼ˆJPEGã€PNGç­‰ï¼‰
4. **æ–‡ä»¶å¤§å°**: OpenAIæ¨¡å‹ä¼šè‡ªåŠ¨å‹ç¼©å›¾åƒï¼Œåƒé—®æ¨¡å‹å»ºè®®æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…
5. **é”™è¯¯å¤„ç†**: ä¸¤ç§æ¨¡å‹éƒ½æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡å‹åˆ›å»ºå¤±è´¥**
   - æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

2. **å›¾åƒåˆ†æå¤±è´¥**
   - æ£€æŸ¥å›¾åƒæ–‡ä»¶æ˜¯å¦æŸå
   - æ£€æŸ¥å›¾åƒæ ¼å¼æ˜¯å¦æ”¯æŒ
   - æ£€æŸ¥APIé…é¢æ˜¯å¦å……è¶³

3. **è¿”å›ç»“æœæ ¼å¼é”™è¯¯**
   - æ£€æŸ¥æ¨¡å‹è¿”å›çš„åŸå§‹æ•°æ®
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
   - ç¡®è®¤æç¤ºè¯æ˜¯å¦æ­£ç¡®

### è°ƒè¯•æ–¹æ³•

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

è¿™å°†è¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œå¸®åŠ©å®šä½é—®é¢˜ã€‚ 